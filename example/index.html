<!DOCTYPE html>
<title>stbvorbis.js Demo</title>
<script src="./stbvorbis.js"></script>
<script>
async function initialize(context) {
  const buf = await (await fetch('./ragtime.ogg')).arrayBuffer();
  let posInSamples = 0;
  return new Promise((resolve, reject) => {
    stbvorbis.decode(buf, function(e) {
      if (e.error) {
        reject(e.error);
        return;
      }

      if (e.eof) {
        resolve();
        return;
      }

      const channels = e.data.length;
      console.log('channels:', channels);
      console.log('length:', e.data[0].length);
      console.log('sampleRate:', e.sampleRate);

      const buffer = context.createBuffer(e.data.length, e.data[0].length, e.sampleRate);
      for (let i = 0; i < channels; i++) {
        // copyToChannel might not be available on Safari.
        if (buffer.copyToChannel) {
          buffer.copyToChannel(e.data[i], i);
        } else {
          buffer.getChannelData(i).set(e.data[i]);
        }
      }
      const source = context.createBufferSource();
      source.buffer = buffer;
      source.connect(context.destination);
      source.start(posInSamples / e.sampleRate);
      posInSamples += e.data[0].length;

      document.getElementById('button').disabled = false;
    });
  });
}

window.addEventListener('DOMContentLoaded', async () => {
  var AudioContext = window.AudioContext || window.webkitAudioContext;
  const context = new AudioContext();
  try {
    await initialize(context);
  } catch(e) {
    console.error(e);
    return;
  }
  document.getElementById('button').addEventListener('click', () => {
    const button = document.getElementById('button');
    switch (button.innerText) {
    case 'Resume':
      context.resume();
      button.innerText = 'Suspend';
      break;
    case 'Suspend':
      context.suspend();
      button.innerText = 'Resume';
      break;
    }
  });
});
</script>
<button id="button" disabled>Suspend</button>
